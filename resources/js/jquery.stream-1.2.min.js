/*
 * jQuery Stream 1.2
 * Comet Streaming JavaScript Library 
 * http://code.google.com/p/jquery-stream/
 * 
 * Copyright 2011, Donghwan Kim 
 * Licensed under the Apache License, Version 2.0
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Compatible with jQuery 1.5+
 */
(function(d){function t(a){var b=document.createElement("div");b.innerHTML="<a href='"+a+"'/>";return b.firstChild.href}function j(a,b,e){for(var b=b.type?b:d.extend(d.Event(b),{bubbles:!1,cancelable:!1},e),e=a.options[b.type],f=[b,a],c=0,g=e.length;c<g;c++)e[c].apply(a.options.context,f);a.options.global&&d.event.trigger("stream"+b.type.substring(0,1).toUpperCase()+b.type.substring(1),f)}function n(a,b){b&&typeof b!=="string"&&(b=l(b));var e=d.now(),f=a.replace(/([?&])_=[^&]*/,"$1_="+e);return f+
(f===a?(/\?/.test(a)?"&":"?")+"_="+e:"")+(b?"&"+b:"")}function l(a){return d.param(a,d.ajaxSettings.traditional)}function o(a,b){var e,b=b||0;(function c(){e=setTimeout(function(){a()!==!1&&c()},b)})();return function(){clearTimeout(e)}}var k={},q={},r={},p=d.browser.webkit&&!d.isReady;p&&d(window).load(function(){p=!1});d.stream=function(a,b){if(!arguments.length){for(var e in k)return k[e];return null}var f=k[a];if(b){if(f&&f.readyState<3)return f}else return f||null;var c={url:a,options:d.stream.setup({},
b),readyState:0,send:function(){},close:function(){}},f=/^(http|ws)s?:/.exec(c.url),g=function(){q[c.options.type](c)};if(f)c.options.type=f[1];for(e in{open:1,message:1,error:1,close:1})c.options[e]=d.makeArray(c.options[e]);k[c.url]=c;c.options.alias&&(k[c.options.alias]=c);if(c.options.type==="ws"||!p)g();else switch(c.options.throbber.type||c.options.throbber){case "lazy":d(window).load(function(){setTimeout(g,c.options.throbber.delay||50)});break;case "reconnect":g(),d(window).load(function(){function a(){c.options.close.push(function(){c.options.close.pop();
setTimeout(function(){d.stream(c.url,c.options)},c.options.throbber.delay||50)});var b=c.options.reconnect;c.close();c.options.reconnect=b}c.readyState===0?c.options.open.push(function(){c.options.open.pop();setTimeout(a,10)}):a()})}return c};d.extend(d.stream,{version:"1.2",setup:function(a,b){b?d.extend(!0,a,d.stream.options,b):(b=a,a=d.extend(!0,d.stream.options,b));for(var e in{context:1,url:1})e in b?a[e]=b[e]:e in d.stream.options&&(a[e]=d.stream.options[e]);return a},options:{type:window.WebSocket?
"ws":"http",reconnect:!0,global:!0,throbber:"lazy",dataType:"text",converters:{text:window.String,json:d.parseJSON,xml:d.parseXML}}});d.extend(q,{ws:function(a){if(window.WebSocket){var b=n(t(a.url).replace(/^http/,"ws"),a.options.openData),e=a.options.protocols?new window.WebSocket(b,a.options.protocols):new window.WebSocket(b);d.extend(e,{onopen:function(b){a.readyState=1;j(a,b)},onmessage:function(b){j(a,d.extend({},b,{data:a.options.converters[a.options.dataType](b.data)}))},onerror:function(b){a.options.reconnect=
!1;j(a,b)},onclose:function(b){var c=a.readyState;a.readyState=3;j(a,b);a.options.reconnect&&c!==0&&d.stream(a.url,a.options)}});d.extend(a,{send:function(b){a.readyState===0&&d.error("INVALID_STATE_ERR: Stream not open");e.send(typeof b==="string"?b:l(b))},close:function(){if(a.readyState<2)a.readyState=2,a.options.reconnect=!1,e.close()}})}},http:function(a){var b,e,f,c,g,h,i=[],m={index:0,data:""};if(b=r[a.options.enableXDR&&window.XDomainRequest?"xdr":window.ActiveXObject?"iframe":window.XMLHttpRequest?
"xhr":null])f=a.options.handleOpen||function(a,b,c){c.id=a.substring(0,a.indexOf(";"));b.index=a.indexOf(";",c.id.length+1)+1},c=a.options.handleMessage||function(a,b){if(b.size==null){var c=a.indexOf(";",b.index);if(c<0)return!1;b.size=+a.substring(b.index,c);b.index=c+1}c=a.substr(b.index,b.size-b.data.length);b.data+=c;b.index+=c.length;if(b.size!==b.data.length)return!1;c=a.indexOf(";",b.index);if(c<0)return!1;b.index=c+1;delete b.size},g=a.options.handleSend||function(a,b,c){c={"metadata.id":c.id,
"metadata.type":a};b.data=a==="close"?l(c):(typeof b.data==="string"?b.data:l(b.data))+"&"+l(c)},e=b(a,{response:function(b){if(a.readyState===0){if(f(b,m,a)===!1)return;a.readyState=1;j(a,"open")}for(;;){if(c(b,m,a)===!1)break;a.readyState<3&&j(a,"message",{data:a.options.converters[a.options.dataType](m.data),origin:"",lastEventId:"",source:null,ports:null});m.data=""}},close:function(b){var c=a.readyState;a.readyState=3;b?(a.options.reconnect=!1,c===0?j(a,"close",{wasClean:!1,code:null,reason:""}):
j(a,"error")):(j(a,"close",{wasClean:!0,code:null,reason:""}),a.options.reconnect&&d.stream(a.url,a.options))}},m),e.open(),d.extend(a,{send:function(b){a.readyState===0&&d.error("INVALID_STATE_ERR: Stream not open");i.push(b);h||(h=!0,function s(){if(a.readyState===1&&i.length){var b={url:a.url,type:"POST",data:i.shift()};g("send",b,a)!==!1?d.ajax(b).complete(s):s()}else h=!1}())},close:function(){if(a.readyState<2){a.readyState=2;var b={url:a.url,type:"POST"};g("close",b,a)!==!1&&d.ajax(b);a.options.reconnect=
!1;e.close()}}})}});d.extend(r,{xhr:function(a,b,e){var f,c,g,h=new window.XMLHttpRequest;h.onreadystatechange=function(){switch(h.readyState){case 3:if(h.status!==200)break;b.response(h.responseText);d.browser.opera&&!c&&(c=!0,f=o(function(){if(h.readyState===4)return!1;h.responseText.length>e.index&&b.response(h.responseText)},a.options.operaInterval));break;case 4:b.close(h.status!==200&&g!==200)}};return{open:function(){h.open("GET",n(a.url,a.options.openData));h.send()},close:function(){f&&f();
try{g=h.status}catch(a){}h.abort()}}},iframe:function(a,b,e){var f,c,g=new window.ActiveXObject("htmlfile");g.open();g.close();return{open:function(){var h=g.createElement("iframe");h.src=n(a.url,a.options.openData);g.body.appendChild(h);var i=h.contentDocument||h.contentWindow.document;f=o(function(){if(i.documentElement){if(i.readyState==="complete")try{d.noop(i.fileSize)}catch(h){return b.close(!0),!1}var g=i.body.lastChild,j=function(){var a=g.cloneNode(!0);a.appendChild(i.createTextNode("."));
a=a.innerText;return a.substring(0,a.length-1)};if(!d.nodeName(g,"pre")){var k=i.head||i.getElementsByTagName("head")[0]||i.documentElement,l=i.createElement("script");l.text="document.write('<plaintext>')";k.insertBefore(l,k.firstChild);k.removeChild(l);g=i.body.lastChild}b.response(j());f=o(function(){var a=j();if(a.length>e.index)b.response(a),g.innerText="",e.index=0;if(i.readyState==="complete")return c||(c=!0,b.close()),!1},a.options.iframeInterval);return!1}})},close:function(){f&&f();g.execCommand("Stop");
c||(c=!0,b.close())}}},xdr:function(a,b){var e=new window.XDomainRequest,d=a.options.rewriteURL||function(a){var b={JSESSIONID:function(b){return a.replace(/;jsessionid=[^\?]*|(\?)|$/,";jsessionid="+b+"$1")},PHPSESSID:function(b){return a.replace(/\?PHPSESSID=[^&]*&?|\?|$/,"?PHPSESSID="+b+"&").replace(/&$/,"")}},c;for(c in b){var d=RegExp("(?:^|;\\s*)"+encodeURIComponent(c)+"=([^;]*)").exec(document.cookie);if(d)return b[c](d[1])}return a};e.onprogress=function(){b.response(e.responseText)};e.onerror=
function(){b.close(!0)};var c=e.onload=function(){b.close()};return{open:function(){e.open("GET",n(d(a.url),a.options.openData));e.send()},close:function(){e.abort();c()}}}});d(window).bind("unload.stream",function(){for(var a in k)k[a].close(),delete k[a]});d.each("streamOpen streamMessage streamError streamClose".split(" "),function(a,b){d.fn[b]=function(a){return this.bind(b,a)}})})(jQuery);